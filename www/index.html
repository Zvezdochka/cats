<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head> 
    <meta http-equiv="content-type" content="text/html; charset=utf-8"> 
<!-- 	<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.7.2/dojo/dojo.js" data-dojo-config="async: true"></script> -->
  
<!--    <link href="style.css" type="text/css" rel="stylesheet" />    -->

    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.v2.js?2.9.1"></script> 
  </head> 

    <body> 
        <div style="float: left; width: 2500px; margin-right: -400px; height: 100%;">  
            <embed id="emb" src="shreda.svg" width="100%" height="100%" type="image/svg+xml" />
        </div>
        <div style="float: left; width: 400px; height: 100%;">
            <embed id="slider_wind" width="100%"  src="slider.svg" type="image/svg+xml" /><br>
            <embed id="slider_gravity" width="100%" src="slider.svg" type="image/svg+xml" />
        </div>
	<script>
    var catNames = [];
    var canvas;
    var windOffset = 0;
    var pos = 0;
    var gravity = 0;
    
	// fetches the document for the given embedding_element
	function getSubDocument(embedding_element)
	{
		if (embedding_element.contentDocument) 
		{
			return embedding_element.contentDocument;
		} 
		else 
		{
			var subdoc = null;
			try 
			{
				subdoc = embedding_element.getSVGDocument();
			} catch(e) {}
			return subdoc;
		}
	}
	
    function redraw()
    {
        var cats = canvas.selectAll('.cat')
                         .data(catNames)
                         .enter()
                             .append('use')
                             .attr('xlink:href', '#shreda')      
                             .attr('x', function(d, i){return i*200})
                             .attr('y', 0)
                             .style('opacity','0')
                             .classed('cat', true)
                         .transition()
                             .duration(3000)
                             .style('opacity', '1') 
                             .each('end', function() {
                                  d3.select(this)
                                    .transition()
                                        //.delay(function(d, i) { return d3.random.normal(500, 500)(); })
                                        .duration(250 / (gravity+1) *10)  
                                        .attr('transform', 'translate(' + windOffset + ', 250)');
                             });
    }

	function findSVG(embed_id)
	{
		var obj = document.getElementById(embed_id); 
        var subDoc = getSubDocument(obj);
        var svg = d3.select(subDoc).select('svg');
        return svg;
	}
	
	function initSlider(sliderObj, on_pos)
	{
		var pos = 0;
		var pointerObj = sliderObj.select("#pointer");
		var stripe = sliderObj.select("#stripe");
		var stripeLength = stripe.node().getBBox().width;

		pointerObj.on('mousedown', function()
		{
			var lastX = d3.event.x;
			sliderObj.on('mousemove', function()
			{
				var moveOffset = d3.event.x - lastX;  
				if (((pos + moveOffset) > stripeLength) || (pos + moveOffset < 0))
				{
					return ;	
				}
				pos += moveOffset;
				lastX = d3.event.x;
				pointerObj.attr('transform', 'translate('+ pos +', 0)');
				
				var newPos = Math.round(pos / stripeLength * 100);  
				on_pos(newPos);
			})
			sliderObj.on('mouseup', function()
			{
				sliderObj.on('mousemove', null);
			});
		})
	}
	
	function init()
	{
			canvas = findSVG('emb');

			// wind
			var sliderWind = findSVG('slider_wind');
			initSlider(sliderWind, function(new_pos) {
				windOffset = new_pos * 1.5;
			});
			
			// gravity
			var sliderGravity = findSVG('slider_gravity');
			initSlider(sliderGravity, function(new_pos)
			{
				gravity = new_pos;
			});
			
            canvas.on('click',function()
            {
                catNames.push('shreda');
                redraw();
            })            
	}                                   
	// wait until all the resources are loaded
	window.addEventListener("load", init, false);

    </script>    
  </body>
</html>